@{
    ViewBag.title = "補打卡申請單";
}

<div class="secion mt-2">
    <div class="card">
        <form method="post" id="app">
            <div class="card-header">

                <h3 class="card-title d-flex justify-content-between">
                    <span>補打卡申請</span>
                </h3>

            </div>
            <div class="card-body">

                <div class="row form-group basic">
                    <label class="col-form-label">申請人</label>
                    <input type="text" class="form-control" :value="name" readonly>

                    <i class="clear-input">
                        <ion-icon name="close-circle" role="img" class="md hydrated" aria-label="close circle"></ion-icon>
                    </i>
                </div>

                <div class="row form-group basic">
                    <label class="col-form-label">補打卡日期</label>
                    <input id="timeRange" name="dateRange" type="datetime" class="form-control" value="" autocomplete="off">
                    <i class="clear-input">
                        <ion-icon name="close-circle" role="img" class="md hydrated" aria-label="close circle"></ion-icon>
                    </i>

                    <div class="wide-block pt-2 pb-2" id="ShiftShow" v-if="search.clockData && search.shiftData">
                        <div class="chip chip-media">
                            <i class="chip-icon bg-warning">
                                <ion-icon name="alarm" role="img" class="md hydrated" aria-label="alarm"></ion-icon>
                            </i>
                            <span class="chip-label">當日打卡時間:{{ formatDateTime(search.clockStart) }} - {{ formatDateTime(search.clockEnd) }}</span>
                        </div>
                        <div class="chip chip-media">
                            <i class="chip-icon bg-warning">
                                <ion-icon name="alarm" role="img" class="md hydrated" aria-label="alarm"></ion-icon>
                            </i>
                            <span class="chip-label">當日班表時間:{{ formatDateTime(matchingData.start) }} - {{ formatDateTime(matchingData.end) }}</span>
                        </div>
                    </div>

                </div>



                <div class="form-group basic">
                    <div class="input-wrapper">
                        <label class="label">補卡時段</label>
                        <select class="form-control select2 select2-hidden-accessible"
                                style="width: 100%;" data-select2-id="1" tabindex="-1"
                                aria-hidden="true" v-model.number="status">
                            <option value="">---請選擇---</option>
                            <option v-for="item in clockStatusSelectItems" :value="item.value">{{item.text}}</option>
                        </select>
                        <span class="select2 select2-container select2-container--default select2-container--below select2-container--focus"
                              dir="ltr" style="width: 100%;">
                            <span class="selection"></span>
                        </span>
                        <span class="text-danger">補卡時段不得為空!</span>
                    </div>
                </div>

                <div class="row form-group basic">
                    <label class="col-form-label">補打卡原因</label>
                    <textarea class="form-control" rows="3"
                              control-id="ControlID-13" v-model="reason"></textarea>
                    <i class="clear-input">
                        <ion-icon name="close-circle" role="img" class="md hydrated" aria-label="close circle"></ion-icon>
                    </i>
                </div>

                @* <div class="form-group basic">
                <div class="input-wrapper">
                <label class="label">簽核人選擇</label>
                <select class="form-control select2 select2-hidden-accessible"
                style="width: 100%;" data-select2-id="1" tabindex="-1"
                aria-hidden="true" v-model="agentEmployeeId">
                <option value="">---請選擇---</option>
                <option v-for="item in agentDropDownList" :value="item.value">{{item.text}}</option>
                </select>
                <span class="select2 select2-container select2-container--default select2-container--below select2-container--focus"
                dir="ltr" style="width: 100%;">
                <span class="selection"></span>
                </span>
                <span class="text-danger" v-if="!validation.agentEmployeeId">代理人選擇不得為空!</span>

                </div>
                </div> *@



            </div>
            <div class="card-footer">

                <div class="row justify-content-around">
                    <button type="button" class="btn btn-facebook" @@click="send">
                        <ion-icon name="notifications-outline" role="img" class="md hydrated" aria-label="logo facebook"></ion-icon>
                        送出
                    </button>
                </div>

            </div>
        </form>
    </div>

    <div class="modal fade dialogbox" id="DialogIconedSuccess" data-backdrop="static" tabindex="-1" role="dialog" style="display: none;" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-icon text-success">
                    <ion-icon name="checkmark-circle" role="img" class="md hydrated" aria-label="checkmark circle"></ion-icon>
                </div>
                <div class="modal-header">
                    <h5 class="modal-title">送出成功</h5>
                </div>
                <div class="modal-body">
                </div>
                <div class="modal-footer">
                    <div class="btn-inline">
                        <a href="#" class="btn" data-dismiss="modal" id="successBack">返回</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade dialogbox" id="DialogIconedDanger" data-backdrop="static" tabindex="-1" role="dialog" style="display: none;" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-icon text-danger">
                    <ion-icon name="close-circle" role="img" class="md hydrated" aria-label="close circle"></ion-icon>
                </div>
                <div class="modal-header">
                    <h5 class="modal-title">送出失敗</h5>
                </div>
                <div class="modal-body">
                </div>
                <div class="modal-footer">
                    <div class="btn-inline">
                        <a href="#" class="btn" data-dismiss="modal" id="dangerBack">返回</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

@*
<div class="section full mb-2">
    <div class="section-title">補打卡</div>
    <div class="wide-block pb-1 pt-2">
        <div class="form-group basic animated mt-3">
            <div class="input-wrapper">
                <label class="form-label font-weight-bold text-primary">申請人</label>
                <input type="text" class="form-control" :value="name" readonly>
                <i class="clear-input">
                    <ion-icon name="close-circle" role="img" class="md hydrated" aria-label="close circle"></ion-icon>
                </i>
            </div>
        </div>

        <div class="form-group basic animated mt-3">
            <div class="input-wrapper">
                <label class="form-label font-weight-bold text-primary">補打卡日期</label>
                <input type="test" class="form-control" id="reservationdate">
                <i class="clear-input">
                    <ion-icon name="close-circle" role="img" class="md hydrated" aria-label="close circle"></ion-icon>
                </i>
                <div class="wide-block pt-2 pb-2" id="ShiftShow" v-if="isValid(search.startTime) && isValid(search.endTime)">
                    <div class="chip chip-media">
                        <i class="chip-icon bg-warning">
                            <ion-icon name="alarm" role="img" class="md hydrated" aria-label="alarm"></ion-icon>
                        </i>
                        <span class="chip-label">當日打卡時間:{{ formatDateTime(search.clockStart) }} - {{ formatDateTime(search.clockEnd) }}</span>
                    </div>
                    <div class="chip chip-media">
                        <i class="chip-icon bg-warning">
                            <ion-icon name="alarm" role="img" class="md hydrated" aria-label="alarm"></ion-icon>
                        </i>
                        <span class="chip-label">當日班表時間:{{ formatDateTime(search.startTime) }} - {{ formatDateTime(search.endTime) }}</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="form-group basic animated mt-3 ">
            <div class="input-wrapper">
                <label class="form-label font-weight-bold text-primary">補卡時段</label>
                <select class="form-control form-select" v-model.number="status">
                    <option v-for="item in clockStatusSelectItems" :value="item.value">{{item.text}}</option>
                </select>
            </div>
        </div>

        <div class="form-group basic animated mt-3">
            <div class="input-wrapper">
                <label class="form-label font-weight-bold text-primary">補打卡原因</label>
                <input type="text" class="form-control" v-model="reason">
                <i class="clear-input">
                    <ion-icon name="close-circle" role="img" class="md hydrated" aria-label="close circle"></ion-icon>
                </i>
            </div>
        </div>

        <div class="form-group basic animated mt-3">
            <div class="input-wrapper">
                <label class="form-label font-weight-bold text-primary" for="審核人員">審核人員</label>
                <input type="text" class="form-control" :value="approvalEmployeeName" readonly>
                <i class="clear-input">
                    <ion-icon name="close-circle" role="img" class="md hydrated" aria-label="close circle"></ion-icon>
                </i>
            </div>
        </div>

    </div>
    <input type="button" value="送出" class="btn btn-outline-primary" @@click="send" />
    <a class="btn btn-outline-dark">取消</a>
</div> *@


@section Scripts {

    <script>
        Vue.createApp({
            data() {
                return {
                    clockStatusSelectItems: [],
                    EmpId: '',
                    name: '',
                    status: '',
                    reason: '',
                    approvalEmployeeName: '',
                    shifts: [],
                    date: '',
                    search: {
                        date: '',
                        startTime: '',
                        endTime: '',
                        clockStart: '',
                        clockEnd: '',
                        shiftData: false,
                        clockData: false,
                    }
                }
            },
            mounted() {
                this.date = this.getToday();
                this.getNameAndId();
                this.getDropDownList();
                this.getDate();

            },
            methods: {
                getNameAndId() {
                    let self = this;
                    fetch("/api/LeaveApi/GetEmployeeName").then(res => res.json()).then(result => {
                        console.log(result);
                        self.name = result.employeeName;
                        self.employeesId = result.employeeId;
                    })
                },
                getDropDownList() {
                    fetch("/api/AdditionalClockInApi/DropDownList").then(res => res.json())
                        .then(result => {
                            this.clockStatusSelectItems = result.clockStatusSelectItems;
                        });
                },
                getDate() {
                    let self = this;
                    $('#timeRange').daterangepicker({
                        "startDate": self.getToday(),
                        singleDatePicker: true,
                        timePicker: false,
                        locale: {
                            format: 'YYYY-MM-DD'
                        }
                    },
                        function (start, _, _) {
                            console.log('selected', start);
                            self.date = start.format('YYYY-MM-DD');
                            self.fetchShifts();
                        }
                    );
                },
                getToday() {
                    console.log(moment().format('YYYY-MM-DD'));
                    return moment().format('YYYY-MM-DD');
                },
                isValid(dateString) {
                    const isValidData = Date.parse(dateString);
                    return !isNaN(isValidData);
                },
                formatDate(dateString) {
                    const options = {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit'
                    };
                    const date = new Date(dateString);
                    return date.toLocaleDateString('zh-TW', options);
                },
                formatDateTime(dateTimeString) {
                    const options = {
                        hour: '2-digit',
                        minute: '2-digit'
                    };
                    const dateTime = new Date(dateTimeString);
                    return dateTime.toLocaleTimeString('zh-TW', options);
                },
                fetchShifts() {
                    let self = this;

                    axios("/mobile/api/Shift/Schedule").then(response => {
                        response.data.forEach(item => {
                            const startDate = item.start.split('T')[0];
                            const startTime = item.start;
                            const endTime = item.end;
                            if (startDate === self.date) {
                                self.search.date = startDate;
                                self.search.startTime = item.start;
                                self.search.endTime = item.end;
                                shiftData = true;
                            }
                        })
                    });

                    // axios("/mobile/api/clock/get").then(response => {
                    //     console.log(response);
                    //     console.log(self.date);
                    //     response.data.forEach(item => {
                    //         const startDate = item.start.split('T')[0];
                    // const clockStart = item.start;
                    // const clockEnd = item.end;
                    //         if (startDate === self.date) {
                    //             self.search.clockStart = item.start;
                    //             self.search.clockEnd = item.end;
                    //         }

                    //     }

                    //         });


                    // fetch(`/api/ClockApi/GetEmpClocks/${this.EmpId}?date=${this.search.date}`)
                    //     .then(res => res.json())
                    //     .then(results => {
                    //         results.forEach(record => {
                    //             if (record.status === 0) {
                    //                 console.log('員工上班打卡');
                    //                 this.search.clockStart = record.date;
                    //             } else if (record.status === 1) {
                    //                 console.log('員工下班打卡');
                    //                 this.search.clockEnd = record.date;
                    //             } else {
                    //                 console.log('未知的打卡狀態');
                    //             }
                    //         });
                    //     });

                },
                send() {
                    let self = this;

                    axios.post("/api/AdditionalClockInApi/CompRequestCreate",{
                        employeesId:self.employeesId,
                        additionalTime: self.date,
                        status: self.status,
                        reason: self.reason,
                    }).then(response => {
                        if (response.data == true) {
                            $('#DialogIconedSuccess').modal('show');
                            $('#successBack').click(function () {
                                $('#DialogIconedSuccess').modal('hide');
                                window.location.href = "/employee/query/CompRequest";
                            });
                        } else {
                            $('#DialogIconedDanger').modal('show');
                            $('#dangerBack').click(function () {
                                $('#DialogIconedDanger').modal('hide');
                            });
                        }
                    });
                },
            }
        }).mount("#app");
    </script>
}