@{
    ViewBag.title = "補打卡申請單";
}

@* <div class="secion mt-2" id="app">
    <div class="card">
        <div class="card-header">
            <h3 class="card-title d-flex justify-content-between">
                <span>補打卡申請單</span>
                <label class="border rounded border-success text-success" style="font-size:16px">
                    編輯中
                </label>
            </h3>
        </div>

        <div class="card-body">
            <div class="row form-group basic">
                <label class="col-form-label">申請人：</label>
                <input type="text" class="form-control" v-model="empName" readonly>
                <i class="clear-input">
                    <ion-icon name="close-circle" role="img" class="md hydrated" aria-label="close circle"></ion-icon>
                </i>
            </div>


            <div class="row form-group basic">
                <label class="col-form-label">補打卡日期：</label>
                <input id="timeRange" type="datetime" class="form-control">
                <span class="text-danger font-weight-bold col-form-label" v-if="!dataValid.overtimeResult">請選擇補打卡日期</span>
                <i class="clear-input">
                    <ion-icon name="close-circle" role="img" class="md hydrated" aria-label="close circle"></ion-icon>
                </i>
            </div>

            <div class="row form-group basic" v-if="isValid(startTime)">
                <label class="col-form-label text-green">加班時數：{{ overtimeResult }}</label>
            </div>

            <div class="row form-group basic">
                <div class="custom-control custom-checkbox mb-1">
                    <input type="checkbox" class="custom-control-input" id="ovetimeCheck" v-model="status">
                    <label class="custom-control-label" for="ovetimeCheck">加班轉補休</label>
                </div>
            </div>

            <div class="row form-group basic">
                <label class="col-form-label">加班原因：</label>
                <textarea cols="5" rows="5" class="form-control" v-model="reason"></textarea>
                <span class="text-danger font-weight-bold" v-if="!dataValid.reason">請說明加班原因</span>
            </div>
        </div>

        <div class="card-footer">
            <div class="row justify-content-around">
                <button type="button" class="btn btn-facebook" @@click="checkIsValidData">
                    <ion-icon name="checkmark-done-outline"></ion-icon>
                    送出
                </button>
                <button type="button" class="btn btn-dribbble" @@click="toList">
                    <ion-icon name="close-outline"></ion-icon>
                    取消
                </button>
            </div>
        </div>
    </div>
</div> *@



<div id="app" class="section full mb-2">
    <div class="section-title">補打卡</div>
    <div class="wide-block pb-1 pt-2">
        <form>
            <div class="form-group basic animated mt-3">
                <div class="input-wrapper">
                    <label class="form-label font-weight-bold text-primary" for="申請人">申請人</label>
                    <input type="text" class="form-control" id="申請人" placeholder="申請人" v-model="EmpId" readonly>
                    <i class="clear-input">
                        <ion-icon name="close-circle" role="img" class="md hydrated" aria-label="close circle"></ion-icon>
                    </i>
                </div>
                <div class="col-sm-auto ml-auto">
                    <button class="btn btn-outline-info pull-right">未送審</button>
                </div>
            </div>
            
            <div class="form-group basic animated mt-3">
                <div class="input-wrapper">
                    <label class="form-label font-weight-bold text-primary" for="補打卡日期">補打卡日期</label>
                    <input type="date" class="form-control" id="補打卡日期" placeholder="補打卡日期">
                    <i class="clear-input">
                        <ion-icon name="close-circle" role="img" class="md hydrated" aria-label="close circle"></ion-icon>
                    </i>
                    <div class="wide-block pt-2 pb-2" id="ShiftShow" v-if="isValid(search.startTime) && isValid(search.endTime)">
                        <div class="chip chip-media">
                            <i class="chip-icon bg-warning">
                                <ion-icon name="alarm" role="img" class="md hydrated" aria-label="alarm"></ion-icon>
                            </i>
                            <span class="chip-label">當日打卡時間:{{ formatDateTime(search.clockStart) }} - {{ formatDateTime(search.clockEnd) }}</span>
                        </div>
                        <div class="chip chip-media">
                            <i class="chip-icon bg-warning">
                                <ion-icon name="alarm" role="img" class="md hydrated" aria-label="alarm"></ion-icon>
                            </i>
                            <span class="chip-label">當日班表時間:{{ formatDateTime(search.startTime) }} - {{ formatDateTime(search.endTime) }}</span>
                        </div>

                    </div>
                </div>
            </div>

            <div class="form-group basic animated mt-3 ">
                <div class="input-wrapper">
                    <label class="form-label font-weight-bold text-primary" for="補卡時段">補卡時段</label>
                    <select id="補卡時段" class="form-control form-select" v-model.number="status">
                        <option v-for="item in clockStatusSelectItems" :value="item.value">{{item.text}}</option>
                    </select>
                </div>
            </div>

            <div class="form-group basic animated mt-3">
                <div class="input-wrapper">
                    <label class="form-label font-weight-bold text-primary" for="補打卡原因">補打卡原因</label>
                    <input type="text" class="form-control" id="補打卡原因" placeholder="補打卡原因" v-model="reason">
                    <i class="clear-input">
                        <ion-icon name="close-circle" role="img" class="md hydrated" aria-label="close circle"></ion-icon>
                    </i>
                </div>
            </div>

            <div class="form-group basic animated mt-3">
                <div class="input-wrapper">
                    <label class="form-label font-weight-bold text-primary" for="審核人員">審核人員</label>
                    <input type="text" class="form-control" id="審核人員" placeholder="審核人員" v-model="approvalEmployeeId" readonly>
                    <i class="clear-input">
                        <ion-icon name="close-circle" role="img" class="md hydrated" aria-label="close circle"></ion-icon>
                    </i>
                </div>
                
            </div>
        </form>

    </div>
    <input type="button" value="送出" class="btn btn-outline-primary" @@click="send" />
    <a class="btn btn-outline-dark">取消</a>
</div>



@section Scripts {

    <script>
        Vue.createApp({
            data() {
                return {
                    clockStatusSelectItems: [],
                    EmpId: 1,
                    status: '',
                    reason: '',
                    approvalEmployeeId: 2,
                    shifts: [],
                    search: {
                        date: '',
                        startTime: '',
                        endTime: '',
                        clockStart: '',
                        clockEnd: ''
                    }
                }
            },
            mounted() {
                const dateInputRef = document.querySelector('#reservationdate');

                $(dateInputRef).daterangepicker({
                    singleDatePicker: true,
                    timePicker: false,
                    locale: {
                        format: 'YYYY/MM/DD'
                    }
                }).on('apply.daterangepicker', (ev, picker) => {
                    const newDate = picker.startDate.format('YYYY/MM/DD');
                    if (this.search.date !== newDate) {
                        this.search.date = newDate;
                        dateInputRef.value = this.search.date;
                        this.fetchShifts();
                    }
                });

                fetch("/api/AdditionalClockInApi/DropDownList").then(res => res.json())
                    .then(result => {
                        this.clockStatusSelectItems = result.clockStatusSelectItems;
                    });
            },
            methods: {
                isValid(dateString) {
                    const isValidData = Date.parse(dateString);
                    return !isNaN(isValidData);
                },
                formatDate(dateString) {
                    const options = {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit'
                    };
                    const date = new Date(dateString);
                    return date.toLocaleDateString('zh-TW', options);
                },
                formatDateTime(dateTimeString) {
                    const options = {
                        hour: '2-digit',
                        minute: '2-digit'
                    };
                    const dateTime = new Date(dateTimeString);
                    return dateTime.toLocaleTimeString('zh-TW', options);
                },
                fetchShifts() {
                    fetch(`/api/ShiftApi/GetEmpShifts/${this.EmpId}?date=${this.search.date}`)
                        .then(res => res.json())
                        .then(result => {
                            this.shifts = result;
                            this.search.date = result[0].shiftsDate;
                            this.search.startTime = result[0].shiftSchedule.startTime;
                            this.search.endTime = result[0].shiftSchedule.endTime;
                        });

                    fetch(`/api/ClockApi/GetEmpClocks/${this.EmpId}?date=${this.search.date}`)
                        .then(res => res.json())
                        .then(results => {
                            results.forEach(record => {
                                if (record.status === 0) {
                                    console.log('員工上班打卡');
                                    this.search.clockStart = record.date;
                                } else if (record.status === 1) {
                                    console.log('員工下班打卡');
                                    this.search.clockEnd = record.date;
                                } else {
                                    console.log('未知的打卡狀態');
                                }
                            });
                        });

                },
                send() {
                    fetch("/api/AdditionalClockInApi/CompRequestCreate", {
                        method: "POST",
                        body: JSON.stringify({
                            EmployeesId: this.EmpId,
                            AdditionalTime: this.search.date,
                            Status: this.status,
                            Reason: this.reason,
                            ApprovalEmployeeId: this.approvalEmployeeId,
                        }),
                        headers: {
                            "content-type": "application/json",
                        },
                    }).then(res => res.json()).then(result => {
                        if (result.status) {
                            alert("新增成功")
                            location.href = "/ApplicationForm/CompRequest"
                        } else {
                            alert("新增失敗")
                        }
                    })
                },
            }
        }).mount("#app");
    </script>
}